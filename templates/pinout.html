{% extends "base.html" %}

{% block title %}Raspberry Pi GPIO Pinout Guide{% endblock %}

{% block content %}
<!-- Hidden field to store the operation mode for JavaScript -->
<input type="hidden" id="operation-mode-value" value="{{ system_config.operation_mode|default('unknown') }}">

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Raspberry Pi 5 GPIO Pinout Guide</h5>
                </div>
                <div class="card-body">
                    <p class="alert alert-info">
                        This page provides a complete pinout guide for connecting all components of the laser cleaning machine to the Raspberry Pi 5.
                    </p>
                    
                    <h4 class="mt-4 mb-3">Visual Connection Diagram</h4>
                    <div class="text-center mb-4">
                        <!-- Raspberry Pi 5 pinout diagram using HTML/CSS -->
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-md-10">
                                    <div class="card bg-dark mb-4">
                                        <div class="card-header bg-primary">
                                            <h5 class="card-title text-center mb-0">Raspberry Pi 5 GPIO Connections</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <!-- Raspberry Pi Board -->
                                                <div class="col-md-12">
                                                    <div class="card bg-dark mb-3">
                                                        <div class="card-header bg-dark">
                                                            <h5 class="text-center text-white mb-0">Raspberry Pi 5</h5>
                                                        </div>
                                                        <div class="card-body text-center" style="background-color: #1e2124;">
                                                            <div class="row g-0">
                                                                <div class="col-6 text-end pe-2">
                                                                    <div class="mb-1"><span class="badge bg-warning">3.3V</span> Pin 1</div>
                                                                    <div class="mb-1"><span class="badge bg-warning">GPIO 2 (1-Wire)</span> Pin 3</div>
                                                                    <div class="mb-1"><span class="badge bg-primary">GPIO {{ gpio_config.step_pin }} (Stepper Step)</span> Pin 5</div>
                                                                    <div class="mb-1"><span class="badge bg-primary">GPIO {{ gpio_config.dir_pin }} (Stepper Dir)</span> Pin 7</div>
                                                                    <div class="mb-1"><span class="badge bg-secondary">GND</span> Pin 9</div>
                                                                    <div class="mb-1"><span class="badge bg-primary">GPIO {{ gpio_config.enable_pin }} (Stepper Enable)</span> Pin 11</div>
                                                                    <div class="mb-1"><span class="badge bg-primary">GPIO {{ gpio_config.home_switch_pin }} (Home Switch)</span> Pin 13</div>
                                                                    <div class="mb-1"><span class="badge bg-danger">GPIO {{ gpio_config.servo_pin }} (Servo PWM)</span> Pin 15</div>
                                                                    <div class="mb-1"><span class="badge bg-warning">3.3V</span> Pin 17</div>
                                                                    <div class="mb-1"><span class="badge bg-info">GPIO 10 (SPI0_MOSI)</span> Pin 19</div>
                                                                    <div class="mb-1"><span class="badge bg-info">GPIO 9 (SPI0_MISO)</span> Pin 21</div>
                                                                    <div class="mb-1"><span class="badge bg-info">GPIO 11 (SPI0_SCLK)</span> Pin 23</div>
                                                                    <div class="mb-1"><span class="badge bg-secondary">GND</span> Pin 25</div>
                                                                    <div class="mb-1"><span class="badge bg-secondary">ID_SD</span> Pin 27</div>
                                                                    <div class="mb-1"><span class="badge bg-secondary">GPIO {{ gpio_config.servo_invert_pin }} (Servo Invert)</span> Pin 29</div>
                                                                    <div class="mb-1"><span class="badge bg-success">GPIO {{ gpio_config.fan_pin }} (Fan)</span> Pin 31</div>
                                                                    <div class="mb-1"><span class="badge bg-success">GPIO {{ gpio_config.red_lights_pin }} (Red Lights)</span> Pin 33</div>
                                                                    <div class="mb-1"><span class="badge bg-success">GPIO {{ gpio_config.table_forward_pin }} (Table Forward)</span> Pin 35</div>
                                                                    <div class="mb-1"><span class="badge bg-success">GPIO {{ gpio_config.table_backward_pin }} (Table Back)</span> Pin 37</div>
                                                                    <div class="mb-1"><span class="badge bg-secondary">GND</span> Pin 39</div>
                                                                </div>
                                                                <div class="col-6 text-start ps-2">
                                                                    <div class="mb-1">Pin 2 <span class="badge bg-danger">5V</span></div>
                                                                    <div class="mb-1">Pin 4 <span class="badge bg-danger">5V</span></div>
                                                                    <div class="mb-1">Pin 6 <span class="badge bg-secondary">GND</span></div>
                                                                    <div class="mb-1">Pin 8 <span class="badge bg-info">GPIO 14 (UART)</span></div>
                                                                    <div class="mb-1">Pin 10 <span class="badge bg-info">GPIO 15 (UART)</span></div>
                                                                    <div class="mb-1">Pin 12 <span class="badge bg-info">GPIO 18 (SPI0_PWM0)</span></div>
                                                                    <div class="mb-1">Pin 14 <span class="badge bg-secondary">GND</span></div>
                                                                    <div class="mb-1">Pin 16 <span class="badge bg-secondary">GPIO {{ gpio_config.in_button_pin }} (IN Button)</span></div>
                                                                    <div class="mb-1">Pin 18 <span class="badge bg-secondary">GPIO {{ gpio_config.out_button_pin }} (OUT Button)</span></div>
                                                                    <div class="mb-1">Pin 20 <span class="badge bg-secondary">GND</span></div>
                                                                    <div class="mb-1">Pin 22 <span class="badge bg-secondary">GPIO {{ gpio_config.fire_button_pin }} (Fire Button)</span></div>
                                                                    <div class="mb-1">Pin 24 <span class="badge bg-info">GPIO 8 (SPI0_CE0)</span></div>
                                                                    <div class="mb-1">Pin 26 <span class="badge bg-info">GPIO 7 (SPI0_CE1)</span></div>
                                                                    <div class="mb-1">Pin 28 <span class="badge bg-secondary">ID_SC</span></div>
                                                                    <div class="mb-1">Pin 30 <span class="badge bg-secondary">GND</span></div>
                                                                    <div class="mb-1">Pin 32 <span class="badge bg-info">GPIO 12 (RFID IRQ)</span></div>
                                                                    <div class="mb-1">Pin 34 <span class="badge bg-secondary">GND</span></div>
                                                                    <div class="mb-1">Pin 36 <span class="badge bg-info">GPIO 16 (RFID RST)</span></div>
                                                                    <div class="mb-1">Pin 38 <span class="badge bg-warning">GPIO {{ gpio_config.table_back_limit_pin }} (Back Limit)</span></div>
                                                                    <div class="mb-1">Pin 40 <span class="badge bg-warning">GPIO {{ gpio_config.table_front_limit_pin }} (Front Limit)</span></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div> <!-- Added missing closing div tag for Raspberry Pi Board -->
                                                
                                                <!-- Color Legend -->
                                                <div class="col-md-6">
                                                    <!-- Color Legend Card -->
                                                    <div class="card bg-dark mb-3">
                                                        <div class="card-header">
                                                            <h6 class="card-title mb-0 text-white">GPIO Pin Color Legend</h6>
                                                        </div>
                                                        <div class="card-body py-2 px-3">
                                                            <div class="d-flex flex-wrap gap-2">
                                                                <div class="mb-1"><span class="badge bg-primary">Stepper Motor</span></div>
                                                                <div class="mb-1"><span class="badge bg-danger">Servo Motor</span></div>
                                                                <div class="mb-1"><span class="badge bg-secondary">Input</span></div>
                                                                <div class="mb-1"><span class="badge bg-success">Output</span></div>
                                                                <div class="mb-1"><span class="badge bg-warning">Sensors</span></div>
                                                                <div class="mb-1"><span class="badge bg-info">SPI/RFID</span></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                
                                                    <!-- Components -->
                                                    <!-- Stepper Motor -->
                                                    <div class="card bg-primary text-white mb-2">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title mb-0">Stepper Motor (Cleaning Head)</h6>
                                                            <div class="small">Connected to: GPIO {{ gpio_config.step_pin }}, {{ gpio_config.dir_pin }}, {{ gpio_config.enable_pin }}, {{ gpio_config.home_switch_pin }}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Servo -->
                                                    <div class="card bg-danger text-white mb-2">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title mb-0">Servo Motor (Trigger)</h6>
                                                            <div class="small">Connected to: GPIO {{ gpio_config.servo_pin }}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Input Buttons -->
                                                    <div class="card bg-secondary text-white mb-2">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title mb-0">Input Buttons/Switches</h6>
                                                            <div class="small">Connected to: GPIO {{ gpio_config.servo_invert_pin }}, {{ gpio_config.in_button_pin }}, {{ gpio_config.out_button_pin }}, {{ gpio_config.fire_button_pin }}</div>
                                                            <div class="small">Each button has dedicated pin - no pin sharing</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Output Controls -->
                                                    <div class="card bg-success text-white mb-2">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title mb-0">Output Controls</h6>
                                                            <div class="small">Connected to: GPIO {{ gpio_config.fan_pin }}, {{ gpio_config.red_lights_pin }}, {{ gpio_config.table_forward_pin }}, {{ gpio_config.table_backward_pin }}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Temperature Sensors -->
                                                    <div class="card bg-warning text-dark mb-2">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title mb-0">DS18B20 Sensors</h6>
                                                            <div class="small">Connected to: GPIO 2 (1-Wire), configurable</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Table Limit Switches -->
                                                    <div class="card bg-warning text-dark mb-2">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title mb-0">Table Limit Switches</h6>
                                                            <div class="small">Connected to: GPIO {{ gpio_config.table_back_limit_pin }}, {{ gpio_config.table_front_limit_pin }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4 mb-3">GPIO Pin Assignments Table</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>GPIO (BCM)</th>
                                    <th>Pin</th>
                                    <th>Component</th>
                                    <th>Function</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>GPIO 2</td>
                                    <td>3</td>
                                    <td>1-Wire Bus</td>
                                    <td>Temperature Sensors</td>
                                    <td>For DS18B20 sensors with 4.7kΩ pull-up resistor</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.step_pin }}</td>
                                    <td>5</td>
                                    <td>Stepper</td>
                                    <td>Step pulse</td>
                                    <td>Connected to stepper driver</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.dir_pin }}</td>
                                    <td>7</td>
                                    <td>Stepper</td>
                                    <td>Direction</td>
                                    <td>Connected to stepper driver</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.enable_pin }}</td>
                                    <td>11</td>
                                    <td>Stepper</td>
                                    <td>Enable</td>
                                    <td>Connected to stepper driver</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.home_switch_pin }}</td>
                                    <td>13</td>
                                    <td>Stepper</td>
                                    <td>Home switch</td>
                                    <td>Limit switch with pull-up resistor</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.servo_pin }}</td>
                                    <td>15</td>
                                    <td>Servo</td>
                                    <td>PWM signal</td>
                                    <td>Connected to servo signal wire</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.in_button_pin }}</td>
                                    <td>16</td>
                                    <td>Input</td>
                                    <td>IN button</td>
                                    <td>With pull-up resistor - dedicated input</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.out_button_pin }}</td>
                                    <td>18</td>
                                    <td>Input</td>
                                    <td>OUT button</td>
                                    <td>With pull-up resistor - dedicated input</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.fire_button_pin }}</td>
                                    <td>22</td>
                                    <td>Input</td>
                                    <td>FIRE button</td>
                                    <td>With pull-up resistor - dedicated input</td>
                                </tr>
                                <tr>
                                    <td>GPIO 10</td>
                                    <td>19</td>
                                    <td>SPI0 / RFID</td>
                                    <td>MOSI</td>
                                    <td>SPI dedicated - not shared</td>
                                </tr>
                                <tr>
                                    <td>GPIO 9</td>
                                    <td>21</td>
                                    <td>SPI0 / RFID</td>
                                    <td>MISO</td>
                                    <td>SPI dedicated - not shared</td>
                                </tr>
                                <tr>
                                    <td>GPIO 11</td>
                                    <td>23</td>
                                    <td>SPI0 / RFID</td>
                                    <td>SCLK</td>
                                    <td>SPI dedicated - not shared</td>
                                </tr>
                                <tr>
                                    <td>GPIO 8</td>
                                    <td>24</td>
                                    <td>SPI0 / RFID</td>
                                    <td>CE0</td>
                                    <td>SPI Chip Enable 0 for RFID reader</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.servo_invert_pin }}</td>
                                    <td>29</td>
                                    <td>Input</td>
                                    <td>Servo invert switch</td>
                                    <td>With pull-up resistor</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.fan_pin }}</td>
                                    <td>31</td>
                                    <td>Output</td>
                                    <td>Fan control</td>
                                    <td>Connected to relay/transistor</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.red_lights_pin }}</td>
                                    <td>33</td>
                                    <td>Output</td>
                                    <td>Red lights</td>
                                    <td>Connected to relay/transistor</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.table_forward_pin }}</td>
                                    <td>35</td>
                                    <td>Output</td>
                                    <td>Table forward</td>
                                    <td>Connected to relay</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.table_backward_pin }}</td>
                                    <td>37</td>
                                    <td>Output</td>
                                    <td>Table backward</td>
                                    <td>Connected to relay</td>
                                </tr>
                                <tr>
                                    <td>GPIO 12</td>
                                    <td>32</td>
                                    <td>RFID</td>
                                    <td>IRQ signal</td>
                                    <td>Interrupt Request - dedicated pin</td>
                                </tr>
                                <tr>
                                    <td>GPIO 16</td>
                                    <td>36</td>
                                    <td>RFID</td>
                                    <td>RST signal</td>
                                    <td>Reset signal - dedicated pin</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.table_front_limit_pin }}</td>
                                    <td>40</td>
                                    <td>Input</td>
                                    <td>Table front limit</td>
                                    <td>With pull-up resistor</td>
                                </tr>
                                <tr>
                                    <td>GPIO {{ gpio_config.table_back_limit_pin }}</td>
                                    <td>38</td>
                                    <td>Input</td>
                                    <td>Table back limit</td>
                                    <td>With pull-up resistor</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ESP32 Pin Assignments Table -->
                    <h4 class="mt-4 mb-3">ESP32 Pin Assignments</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>GPIO (ESP32)</th>
                                    <th>Component</th>
                                    <th>Function</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ gpio_config.esp_step_pin }}</td>
                                    <td>Stepper</td>
                                    <td>STEP</td>
                                    <td>Stepper step pulse (LOW=Enable)</td>
                                </tr>
                                <tr>
                                    <td>{{ gpio_config.esp_dir_pin }}</td>
                                    <td>Stepper</td>
                                    <td>DIR</td>
                                    <td>Stepper direction</td>
                                </tr>
                                <tr>
                                    <td>{{ gpio_config.esp_enable_pin }}</td>
                                    <td>Stepper</td>
                                    <td>EN</td>
                                    <td>Stepper enable (LOW=Enable)</td>
                                </tr>
                                <tr>
                                    <td>{{ gpio_config.esp_limit_a_pin }}</td>
                                    <td>Stepper</td>
                                    <td>Limit A</td>
                                    <td>Limit switch A (Pull-Up, LOW=Enable)</td>
                                </tr>
                                <tr>
                                    <td>{{ gpio_config.esp_limit_b_pin }}</td>
                                    <td>Stepper</td>
                                    <td>Limit B</td>
                                    <td>Limit switch B (Pull-Up, LOW=Enable)</td>
                                </tr>
                                <tr>
                                    <td>{{ gpio_config.esp_home_pin }}</td>
                                    <td>Stepper</td>
                                    <td>Home</td>
                                    <td>Home switch (Pull-Up, LOW=Enable)</td>
                                </tr>
                                <tr>
                                    <td>{{ gpio_config.esp_servo_pwm_pin }}</td>
                                    <td>Servo</td>
                                    <td>PWM</td>
                                    <td>Servo PWM output</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h4 class="mt-4 mb-3">All Pin Assignments (Summary)</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Device</th>
                                    <th>GPIO</th>
                                    <th>Pin</th>
                                    <th>Component</th>
                                    <th>Function</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Raspberry Pi Pins -->
                                <tr><td rowspan="16" class="align-middle text-center">Raspberry Pi 5</td><td>GPIO {{ gpio_config.step_pin }}</td><td>25</td><td>Stepper</td><td>STEP</td><td>Step pulse</td></tr>
                                <tr><td>GPIO {{ gpio_config.dir_pin }}</td><td>26</td><td>Stepper</td><td>DIR</td><td>Direction</td></tr>
                                <tr><td>GPIO {{ gpio_config.enable_pin }}</td><td>27</td><td>Stepper</td><td>EN</td><td>Enable (LOW=Enable)</td></tr>
                                <tr><td>GPIO {{ gpio_config.home_switch_pin }}</td><td>34</td><td>Stepper</td><td>Home</td><td>Home switch</td></tr>
                                <tr><td>GPIO {{ gpio_config.servo_pin }}</td><td>12</td><td>Servo</td><td>PWM</td><td>Servo PWM</td></tr>
                                <tr><td>GPIO {{ gpio_config.button_in_pin }}</td><td>5</td><td>Button</td><td>IN</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>GPIO {{ gpio_config.button_out_pin }}</td><td>7</td><td>Button</td><td>OUT</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>GPIO {{ gpio_config.fire_button_pin }}</td><td>22</td><td>Button</td><td>FIRE</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>GPIO {{ gpio_config.servo_invert_switch_pin }}</td><td>29</td><td>Button</td><td>Invert</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>GPIO {{ gpio_config.fan_pin }}</td><td>31</td><td>Output</td><td>Fan</td><td>Fan control</td></tr>
                                <tr><td>GPIO {{ gpio_config.red_lights_pin }}</td><td>33</td><td>Output</td><td>Red Lights</td><td>Red lights control</td></tr>
                                <tr><td>GPIO {{ gpio_config.table_forward_pin }}</td><td>26</td><td>Table</td><td>FW</td><td>Table forward</td></tr>
                                <tr><td>GPIO {{ gpio_config.table_backward_pin }}</td><td>16</td><td>Table</td><td>RV</td><td>Table reverse</td></tr>
                                <tr><td>GPIO {{ gpio_config.table_front_switch_pin }}</td><td>40</td><td>Table</td><td>FLimit</td><td>Front limit switch</td></tr>
                                <tr><td>GPIO {{ gpio_config.table_back_switch_pin }}</td><td>38</td><td>Table</td><td>BLimit</td><td>Back limit switch</td></tr>
                                <tr><td>GPIO 4</td><td>4</td><td>Temp</td><td>1-Wire</td><td>DS18B20</td></tr>
                                <!-- ESP32 Pins -->
                                <tr><td rowspan="7" class="align-middle text-center">ESP32</td><td>{{ gpio_config.esp_step_pin }}</td><td>25</td><td>Stepper</td><td>STEP</td><td>Step pulse (LOW=Enable)</td></tr>
                                <tr><td>{{ gpio_config.esp_dir_pin }}</td><td>26</td><td>Stepper</td><td>DIR</td><td>Direction</td></tr>
                                <tr><td>{{ gpio_config.esp_enable_pin }}</td><td>27</td><td>Stepper</td><td>EN</td><td>Enable (LOW=Enable)</td></tr>
                                <tr><td>{{ gpio_config.esp_limit_a_pin }}</td><td>32</td><td>Stepper</td><td>Limit A</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>{{ gpio_config.esp_limit_b_pin }}</td><td>33</td><td>Stepper</td><td>Limit B</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>{{ gpio_config.esp_home_pin }}</td><td>34</td><td>Stepper</td><td>Home</td><td>Pull-Up, LOW=Enable</td></tr>
                                <tr><td>{{ gpio_config.esp_servo_pwm_pin }}</td><td>12</td><td>Servo</td><td>PWM</td><td>Servo PWM</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Power Connections</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Pin</th>
                                    <th>Connection</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>3.3V</td>
                                    <td>For logic-level components only, max 800mA</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>5V</td>
                                    <td>For servos and relays, max 4A with good cooling</td>
                                </tr>
                                <tr>
                                    <td>6, 9, 14, 20, 25, 30, 34, 39</td>
                                    <td>GND</td>
                                    <td>Ground connection points</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h4 class="mt-4 mb-3">RFID Reader for Machine Access Control</h4>
                    <div class="alert alert-info">
                        <h5>RFID Reader Integration</h5>
                        <p>The system supports RFID reader integration via SPI for machine access control. This feature allows authentication with the ShopMachineMonitor server (part of the ShopTracker ecosystem) for secure machine operation.</p>
                        
                        <h5>Hardware Connection</h5>
                        <ul>
                            <li><strong>RFID Reader Module:</strong> MFRC522 or compatible SPI RFID reader</li>
                            <li><strong>SPI Connection:</strong>
                                <ul>
                                    <li>MOSI (RFID): GPIO 10 (Pin 19) - SPI dedicated</li>
                                    <li>MISO (RFID): GPIO 9 (Pin 21) - SPI dedicated</li>
                                    <li>SCLK (RFID): GPIO 11 (Pin 23) - SPI dedicated</li>
                                    <li>CE0/SDA (RFID): GPIO 8 (Pin 24) - SPI dedicated</li>
                                    <li>IRQ (RFID): GPIO 12 (Pin 32) - RFID dedicated</li>
                                    <li>RST (RFID): GPIO 16 (Pin 36) - RFID dedicated, optional</li>
                                    <li>3.3V: Pin 1 or 17</li>
                                    <li>GND: Any ground pin</li>
                                </ul>
                            </li>
                        </ul>
                        
                        <h5>Software Configuration</h5>
                        <ol>
                            <li>Enable SPI in Raspberry Pi configuration:
                                <pre>sudo raspi-config</pre>
                                Navigate to Interface Options > SPI > Enable
                            </li>
                            <li>Install required libraries:
                                <pre>pip install mfrc522</pre>
                            </li>
                            <li>Configure the server connection in settings:
                                <ul>
                                    <li>Server URL: https://Shopmachinemonitor.replit.app/api/auth</li>
                                    <li>API Key: Obtain from ShopMachineMonitor administrator</li>
                                    <li>Machine ID: Unique identifier for this machine</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h5>Access Control Features</h5>
                        <ul>
                            <li>Integration with ShopMachineMonitor for user authentication</li>
                            <li>User access level management (operator, admin, maintenance)</li>
                            <li>Machine operation logging with user identification</li>
                            <li>Automatic watchdog for secure operation shutdown if connection lost</li>
                            <li>Remote monitoring and control through the ShopTracker ecosystem</li>
                        </ul>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Safety Considerations</h4>
                    <div class="alert alert-warning">
                        <h5>Emergency Stop</h5>
                        <p>Implement a hardware emergency stop that cuts power to motors and laser. The E-stop should NOT rely on the Raspberry Pi to function.</p>
                        
                        <h5>Temperature Monitoring</h5>
                        <p>The system includes automatic shutdown when high temperatures are detected. Place temperature sensors on critical components (laser power supply, control box).</p>
                        
                        <h5>Limit Switches</h5>
                        <p>Table movement and cleaning head have limit switches to prevent overtravel. Verify their function before operating at full speed.</p>
                        
                        <h5>Optical Safety</h5>
                        <p>The red lights indicate when the laser is active. Ensure proper laser safety protocols are followed at all times.</p>
                    </div>
                    
                    <div class="alert alert-primary mt-4">
                        <h5>Software Configuration</h5>
                        <p>Refer to the <code>machine_config.json</code> file for software pin assignments and settings. The pin configurations in the software match the hardware connections described in this page.</p>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Temperature Sensor Configuration</h4>
                    <div class="alert alert-info">
                        <h5>DS18B20 1-Wire Setup</h5>
                        <p>The DS18B20 temperature sensors use the 1-Wire protocol connected to GPIO 2 (physical pin 3) by default. For proper operation:</p>
                        <ol>
                            <li>Make sure <code>/boot/config.txt</code> contains the appropriate line:
                                <ul>
                                    <li>For GPIO 2: <code>dtoverlay=w1-gpio,gpiopin=2</code></li>
                                    <li>For GPIO 4 (default): <code>dtoverlay=w1-gpio</code> (without gpiopin parameter)</li>
                                    <li>For GPIO 17: <code>dtoverlay=w1-gpio,gpiopin=17</code></li>
                                    <li>For GPIO 27: <code>dtoverlay=w1-gpio,gpiopin=27</code></li>
                                </ul>
                            </li>
                            <li>Connect the DS18B20 data wire to the configured GPIO pin with a 4.7kΩ pull-up resistor to 3.3V</li>
                            <li>Load required kernel modules with:
                                <pre>sudo modprobe w1-gpio
sudo modprobe w1-therm</pre>
                            </li>
                            <li>Verify sensors are detected with: <code>ls /sys/bus/w1/devices/</code></li>
                        </ol>
                        <p>The GPIO pin used for 1-Wire can be changed in the Temperature Settings page. After changing the setting, you must update the hardware connection and reboot the Raspberry Pi for changes to take effect.</p>
                    </div>
                    
                    <h4 class="mt-4 mb-3">Troubleshooting Temperature Sensors</h4>
                    <div class="alert alert-warning">
                        <h5>Sensor Not Detected</h5>
                        <ol>
                            <li>Check the GPIO pin configuration in Temperature Settings matches hardware connection</li>
                            <li>Verify the 4.7kΩ pull-up resistor is properly connected between the data line and 3.3V</li>
                            <li>Confirm sensors are powered correctly (RED: 3.3-5V, BLACK: GND, YELLOW/BLUE: DATA)</li>
                            <li>Check for proper kernel modules loading with: <code>lsmod | grep w1</code></li>
                            <li>Ensure sensor isn't damaged by testing with a different sensor</li>
                            <li>Verify <code>/boot/config.txt</code> has the correct dtoverlay entry and reboot</li>
                        </ol>
                        
                        <h5>Bad Readings</h5>
                        <ol>
                            <li>Ensure proper cable length (preferably less than 20m)</li>
                            <li>Check for electrical interference by relocating sensors or using shielded cable</li>
                            <li>Confirm power supply is adequate for the number of sensors connected</li>
                            <li>Verify sensor is properly seated and has good thermal contact with measured surface</li>
                            <li>If parasitic power mode is used, ensure strong pull-up is enabled</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- IO Testing Panel -->
<div class="card mt-4 mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">GPIO IO Testing</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            This panel allows you to test GPIO inputs and outputs without affecting the main application.
        </div>
        
        <!-- Input Testing -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary">
                        <h5 class="card-title mb-0">Input Testing</h5>
                    </div>
                    <div class="card-body">
                        <p>Monitor the state of input pins:</p>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>GPIO</th>
                                        <th>Function</th>
                                        <th>State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>GPIO {{ gpio_config.in_button_pin }}</td>
                                        <td>IN Button</td>
                                        <td><span id="gpio{{ gpio_config.in_button_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                    <tr>
                                        <td>GPIO {{ gpio_config.out_button_pin }}</td>
                                        <td>OUT Button</td>
                                        <td><span id="gpio{{ gpio_config.out_button_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                    <tr>
                                        <td>GPIO {{ gpio_config.fire_button_pin }}</td>
                                        <td>FIRE Button</td>
                                        <td><span id="gpio{{ gpio_config.fire_button_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                    <tr>
                                        <td>GPIO {{ gpio_config.servo_invert_pin }}</td>
                                        <td>Servo Invert</td>
                                        <td><span id="gpio{{ gpio_config.servo_invert_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                    <tr>
                                        <td>GPIO {{ gpio_config.home_switch_pin }}</td>
                                        <td>Home Switch</td>
                                        <td><span id="gpio{{ gpio_config.home_switch_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                    <tr>
                                        <td>GPIO {{ gpio_config.table_back_limit_pin }}</td>
                                        <td>Table Back Limit</td>
                                        <td><span id="gpio{{ gpio_config.table_back_limit_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                    <tr>
                                        <td>GPIO {{ gpio_config.table_front_limit_pin }}</td>
                                        <td>Table Front Limit</td>
                                        <td><span id="gpio{{ gpio_config.table_front_limit_pin }}-state" class="badge bg-dark">Unknown</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button id="refresh-inputs" class="btn btn-primary mt-2">
                            <i class="fas fa-sync-alt me-1"></i> Refresh Inputs
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Output Testing -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success">
                        <h5 class="card-title mb-0">Output Testing</h5>
                    </div>
                    <div class="card-body">
                        <p>Control output pins individually for testing:</p>
                        <div class="mb-3">
                            <label class="form-label">Fan (GPIO {{ gpio_config.fan_pin }})</label>
                            <div class="d-flex">
                                <button id="fan-on" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-power-off me-1"></i> ON
                                </button>
                                <button id="fan-off" class="btn btn-sm btn-danger">
                                    <i class="fas fa-power-off me-1"></i> OFF
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Red Lights (GPIO {{ gpio_config.red_lights_pin }})</label>
                            <div class="d-flex">
                                <button id="lights-on" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-power-off me-1"></i> ON
                                </button>
                                <button id="lights-off" class="btn btn-sm btn-danger">
                                    <i class="fas fa-power-off me-1"></i> OFF
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Table Forward (GPIO {{ gpio_config.table_forward_pin }})</label>
                            <div class="d-flex">
                                <button id="table-forward-on" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-power-off me-1"></i> ON
                                </button>
                                <button id="table-forward-off" class="btn btn-sm btn-danger">
                                    <i class="fas fa-power-off me-1"></i> OFF
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Table Backward (GPIO {{ gpio_config.table_backward_pin }})</label>
                            <div class="d-flex">
                                <button id="table-backward-on" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-power-off me-1"></i> ON
                                </button>
                                <button id="table-backward-off" class="btn btn-sm btn-danger">
                                    <i class="fas fa-power-off me-1"></i> OFF
                                </button>
                            </div>
                        </div>
                        <div class="alert alert-warning small mt-3">
                            <i class="fas fa-exclamation-triangle me-1"></i> Output testing may affect machine operation. Ensure machine is in a safe state before testing.
                        </div>
                    </div>
                </div>
                    
                <!-- GPIO Pin Configuration Section moved from settings page -->
                <div class="card mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-microchip me-2"></i>
                            GPIO Pin Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> Changing GPIO pin assignments will require a system restart to take effect.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Stepper Motor Pins</h5>
                                <form id="gpio-stepper-form">
                                    <div class="mb-3">
                                        <label for="dir_pin" class="form-label">DIR Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="dir_pin" name="dir_pin" 
                                                value="{{ gpio_config.dir_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'dir_pin', document.getElementById('dir_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="step_pin" class="form-label">STEP Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="step_pin" name="step_pin" 
                                                value="{{ gpio_config.step_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'step_pin', document.getElementById('step_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="enable_pin" class="form-label">ENABLE Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="enable_pin" name="enable_pin" 
                                                value="{{ gpio_config.enable_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'enable_pin', document.getElementById('enable_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="home_switch_pin" class="form-label">Home Switch Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="home_switch_pin" name="home_switch_pin" 
                                                value="{{ gpio_config.home_switch_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'home_switch_pin', document.getElementById('home_switch_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>Servo & Input Pins</h5>
                                <form id="gpio-servo-form">
                                    <div class="mb-3">
                                        <label for="servo_pin" class="form-label">Servo Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="servo_pin" name="servo_pin" 
                                                value="{{ gpio_config.servo_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'servo_pin', document.getElementById('servo_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="in_button_pin" class="form-label">IN Button Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="in_button_pin" name="in_button_pin" 
                                                value="{{ gpio_config.in_button_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'in_button_pin', document.getElementById('in_button_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="out_button_pin" class="form-label">OUT Button Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="out_button_pin" name="out_button_pin" 
                                                value="{{ gpio_config.out_button_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'out_button_pin', document.getElementById('out_button_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="fire_button_pin" class="form-label">FIRE Button Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="fire_button_pin" name="fire_button_pin" 
                                                value="{{ gpio_config.fire_button_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'fire_button_pin', document.getElementById('fire_button_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="servo_invert_pin" class="form-label">Servo Invert Switch Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="servo_invert_pin" name="servo_invert_pin" 
                                                value="{{ gpio_config.servo_invert_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'servo_invert_pin', document.getElementById('servo_invert_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h5>Output Pins</h5>
                                <form id="gpio-output-form">
                                    <div class="mb-3">
                                        <label for="fan_pin" class="form-label">Fan Control Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="fan_pin" name="fan_pin" 
                                                value="{{ gpio_config.fan_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'fan_pin', document.getElementById('fan_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="red_lights_pin" class="form-label">Red Lights Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="red_lights_pin" name="red_lights_pin" 
                                                value="{{ gpio_config.red_lights_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'red_lights_pin', document.getElementById('red_lights_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>Table Control Pins</h5>
                                <form id="gpio-table-form">
                                    <div class="mb-3">
                                        <label for="table_forward_pin" class="form-label">Table Forward Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="table_forward_pin" name="table_forward_pin" 
                                                value="{{ gpio_config.table_forward_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'table_forward_pin', document.getElementById('table_forward_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="table_backward_pin" class="form-label">Table Backward Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="table_backward_pin" name="table_backward_pin" 
                                                value="{{ gpio_config.table_backward_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'table_backward_pin', document.getElementById('table_backward_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="table_front_limit_pin" class="form-label">Table Front Limit Switch Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="table_front_limit_pin" name="table_front_limit_pin" 
                                                value="{{ gpio_config.table_front_limit_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'table_front_limit_pin', document.getElementById('table_front_limit_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="table_back_limit_pin" class="form-label">Table Back Limit Switch Pin (BCM)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="table_back_limit_pin" name="table_back_limit_pin" 
                                                value="{{ gpio_config.table_back_limit_pin }}" min="0" max="27">
                                            <button class="btn btn-warning" type="button" 
                                                    onclick="updateConfig('gpio', 'table_back_limit_pin', document.getElementById('table_back_limit_pin').value)">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GPIO Config Update Modal -->
<div class="modal fade" id="configUpdateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt me-2"></i>
                    Restart Required
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>GPIO pin settings have been updated. The application needs to be restarted for these changes to take effect.</p>
                <p>Would you like to restart now?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
                <button type="button" class="btn btn-warning" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Restart Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for the configuration updates -->
<script>
    function updateConfig(section, key, value) {
        fetch('/update_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                section: section,
                key: key,
                value: value
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success toast
                const toast = document.getElementById('statusToast');
                const toastBody = document.getElementById('statusToastBody');
                toastBody.textContent = data.message;
                
                toast.classList.remove('bg-danger');
                toast.classList.add('bg-success');
                
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                // Show restart modal if GPIO settings were updated
                if (section === 'gpio') {
                    const restartModal = new bootstrap.Modal(document.getElementById('configUpdateModal'));
                    restartModal.show();
                }
            } else {
                // Show error toast
                const toast = document.getElementById('statusToast');
                const toastBody = document.getElementById('statusToastBody');
                toastBody.textContent = data.message || 'Error updating configuration.';
                
                toast.classList.remove('bg-success');
                toast.classList.add('bg-danger');
                
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }
        })
        .catch(error => {
            console.error('Error updating configuration:', error);
        });
    }
</script>

<!-- Status Toast -->
<div id="statusToast" class="toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body" id="statusToastBody">
            Configuration updated successfully!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
</div>
{% endblock %}

{% block head %}
<!-- No inline JavaScript here - using the gpio_test.js file instead -->
{% endblock %}

{% block scripts %}
<!-- Include the GPIO testing JavaScript -->
<script src="{{ url_for('static', filename='js/gpio_test.js') }}"></script>
{% endblock %}